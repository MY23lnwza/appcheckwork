<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 900px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .card { border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px; background-color: #f9f9f9; }
        h3 { color: #333; }
        p { margin: 5px 0; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        textarea { width: calc(100% - 10px); padding: 5px; margin-top: 5px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 3px; resize: vertical; }
        button { padding: 8px 12px; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; color: white; background-color: #007bff; }
        button:hover { opacity: 0.9; }
        button[style*="background:#f44336"] { background-color: #f44336; } /* Red for delete */
        button[onclick*="updateStatus"][style*="background:#f44336"] { background-color: #f44336; } /* Example: make edit button orange */

        .status-green { color: green; font-weight: bold; }
        .status-orange { color: orange; font-weight: bold; }
        .status-yellow { color: rgb(204, 204, 0); font-weight: bold; }

        .role-selector { margin-bottom: 20px; display: flex; align-items: center; gap: 10px;}
        .role-selector label { font-weight: bold; }
        .task-sections { display: flex; gap: 20px; flex-wrap: wrap; }
        .task-section { flex: 1; min-width: 300px; background-color: #eee; padding: 15px; border-radius: 5px; }
        .task-section h2 { border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-top: 0; }

        /* Style for Add Task Form */
        .add-task-form { margin-top: 20px; padding: 20px; border: 1px dashed #ccc; border-radius: 5px; background-color: #e9f7ef; }
        .add-task-form label { display: block; margin-bottom: 5px; font-weight: bold; }
        .add-task-form input[type="text"],
        .add-task-form input[type="date"],
        .add-task-form textarea,
        .add-task-form select {
            width: calc(100% - 22px); /* Adjust for padding and border */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .add-task-form button { background-color: #28a745; margin-top: 10px; }
        .add-task-form button:hover { background-color: #218838; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h1>

        <div class="role-selector">
            <label for="userRole">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:</label>
            <select id="userRole" onchange="changeRole()">
                <option value="admin">Admin</option>
                <option value="user">User</option>
            </select>
            <label for="currentUserSelect">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</label>
            <select id="currentUserSelect" onchange="changeUser()"></select>
        </div>

        <div id="addTaskForm" class="add-task-form" style="display: none;">
            <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
            <label for="taskTitle">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô:</label>
            <input type="text" id="taskTitle" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà">

            <label for="taskOrderDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô:</label>
            <input type="date" id="taskOrderDate">

            <label for="taskDueDate">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á:</label>
            <input type="date" id="taskDueDate">

            <label for="taskBrief">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ö‡∏£‡∏µ‡∏ü (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
            <input type="text" id="taskBrief" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://docs.google.com/document/d/... ‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏≠‡∏∑‡πà‡∏ô‡πÜ">

            <label for="taskAssignTo">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ:</label>
            <select id="taskAssignTo"></select>

            <label for="taskAdminNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô):</label>
            <textarea id="taskAdminNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á"></textarea>

            <button onclick="addTask()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
        </div>

        <hr>

        <div class="task-sections">
            <div id="adminSection" class="task-section" style="display: none;">
                <h2>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Admin View)</h2>
                <div id="adminTasks">
                    </div>
            </div>

            <div id="userSection" class="task-section" style="display: none;">
                <h2>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ (User View)</h2>
                <div id="userTasks">
                    </div>
            </div>

            <div id="userSubmittedSection" class="task-section" style="display: none;">
                <h2>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (User View)</h2>
                <div id="userSubmitted">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // *** IMPORTANT: Replace with your deployed Google Apps Script Web App URL ***
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzZtrON27_A_3kqhn4MAr9n6_Egi_uObT8aq3k_Jnywx1lPbO4UhD_0e757dCef8Sohfg/exec";

        let tasks = []; // Global array to store tasks
        let currentRole = "admin"; // Default role
        let currentUser = ""; // Default user

        // All possible users fetched from tasks
        let allUsers = [];

        // Function to fetch tasks from Google Apps Script
        async function fetchTasks() {
            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                tasks = await response.json();
                console.log("Fetched tasks:", tasks); // For debugging
                extractUsers(); // Extract users for the dropdown
                renderTasks(); // Re-render tasks after fetching
            } catch (error) {
                console.error("Error fetching tasks:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô: " + error.message);
            }
        }

        // Function to extract unique users from tasks
        function extractUsers() {
            const users = new Set();
            tasks.forEach(task => {
                if (task.assignTo) {
                    users.add(task.assignTo);
                }
            });
            allUsers = Array.from(users).sort(); // Convert to array and sort
            populateUserDropdown();
        }

        // Function to populate the user dropdown
        function populateUserDropdown() {
            const select = document.getElementById("currentUserSelect");
            select.innerHTML = ''; // Clear existing options

            // Add an empty option if there are no users yet
            if (allUsers.length === 0) {
                const option = document.createElement("option");
                option.value = "";
                option.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                select.appendChild(option);
            } else {
                allUsers.forEach(user => {
                    const option = document.createElement("option");
                    option.value = user;
                    option.textContent = user;
                    select.appendChild(option);
                });
            }

            // Set the current user if it's still valid, or default to the first user
            if (currentUser && allUsers.includes(currentUser)) {
                select.value = currentUser;
            } else if (allUsers.length > 0) {
                currentUser = allUsers[0];
                select.value = currentUser;
            } else {
                currentUser = ""; // No users available
            }

            // Also populate the assignTo dropdown in the add task form
            const assignToSelect = document.getElementById("taskAssignTo");
            assignToSelect.innerHTML = ''; // Clear existing options
            allUsers.forEach(user => {
                const option = document.createElement("option");
                option.value = user;
                option.textContent = user;
                assignToSelect.appendChild(option);
            });
            // Add an option to add a new user if not in admin role, or always show if admin
            const newOption = document.createElement("option");
            newOption.value = "addNewUser";
            newOption.textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà...";
            assignToSelect.appendChild(newOption);

            assignToSelect.onchange = function() {
                if (this.value === "addNewUser") {
                    const newUser = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:");
                    if (newUser) {
                        if (!allUsers.includes(newUser)) {
                            allUsers.push(newUser);
                            allUsers.sort();
                            populateUserDropdown(); // Re-populate all dropdowns
                            this.value = newUser; // Select the new user in assignTo
                        } else {
                            alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
                            this.value = currentUser; // Revert to current user or default
                        }
                    } else {
                        this.value = currentUser; // Revert if cancelled
                    }
                }
            };

            updateUIForRole(); // Update UI after user dropdown is set
        }

        // Function to change the current role (Admin/User)
        function changeRole() {
            currentRole = document.getElementById("userRole").value;
            updateUIForRole();
            renderTasks();
        }

        // Function to change the current logged-in user
        function changeUser() {
            currentUser = document.getElementById("currentUserSelect").value;
            renderTasks();
        }

        // Function to show/hide sections based on role
        function updateUIForRole() {
            const isAdmin = currentRole === "admin";
            document.getElementById("adminSection").style.display = isAdmin ? "block" : "none";
            document.getElementById("userSection").style.display = isAdmin ? "none" : "block";
            document.getElementById("userSubmittedSection").style.display = isAdmin ? "none" : "block";
            document.getElementById("addTaskForm").style.display = isAdmin ? "block" : "none";
            document.getElementById("currentUserSelect").disabled = isAdmin; // Disable user selection for admin view
            document.getElementById("currentUserSelect").parentNode.style.display = isAdmin ? 'none' : 'flex'; // Hide user selection for admin
        }

        // Function to format date to "‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ" Thai format
        function formatDate(dateStr) {
            if (!dateStr) return "-";
            // Ensure dateStr is treated as UTC to avoid timezone issues when parsing simple dates
            // If dateStr is already a full ISO string, new Date() handles it well.
            // If it's just "YYYY-MM-DD", treat it carefully.
            const d = new Date(dateStr + "T00:00:00"); // Append T00:00:00 to treat as start of day UTC
            if (isNaN(d.getTime())) {
                console.warn("Invalid date string:", dateStr);
                return dateStr; // Fallback if invalid date
            }
            return d.toLocaleDateString("th-TH", {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric'
            });
        }

        // Function to format date-time to "‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á:‡∏ô‡∏≤‡∏ó‡∏µ:‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ" Thai format
        function formatDateTime(dateStr) {
            if (!dateStr) return "-";
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) {
                console.warn("Invalid date-time string:", dateStr);
                return dateStr; // Fallback if invalid date
            }
            return d.toLocaleDateString("th-TH", {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }


        // --- Core Rendering Function ---
        function renderTasks() {
            const adminDiv = document.getElementById("adminTasks");
            const userDiv = document.getElementById("userTasks");
            const userSub = document.getElementById("userSubmitted");
            adminDiv.innerHTML = "";
            userDiv.innerHTML = "";
            userSub.innerHTML = "";

            if (tasks.length === 0) {
                if (currentRole === "admin") {
                    adminDiv.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö.</p>";
                } else {
                    userDiv.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ.</p>";
                    userSub.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß.</p>";
                }
                return;
            }


            tasks.forEach((t) => {
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                const orderDateFormatted = formatDate(t.orderDate);
                const dueFormatted = formatDate(t.due);
                // ‡πÉ‡∏ä‡πâ formatDateTime ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö submitDate ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡πâ‡∏ß‡∏¢
                const submitDateFormatted = formatDateTime(t.submitDate);

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ
                const statusClass =
                    t.status === "approved"
                        ? "status-green"
                        : t.status === "edit"
                        ? "status-orange"
                        : "status-yellow"; // 'assigned' or 'submitted'

                const baseInfo = `
                    <div class="card" id="task-${t.id}">
                        <h4>${t.title}</h4>
                        <p>üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: <strong>${t.assignTo}</strong> | üìÖ ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: ${orderDateFormatted} | üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${dueFormatted}</p>
                        <p>üîó <a href="${t.brief || "#"}" target="_blank">‡∏ö‡∏£‡∏µ‡∏ü</a></p>
                        <p>${t.adminNote ? "üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô): " + t.adminNote : ""}</p>
                        <p class="${statusClass}">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <strong>${t.status}</strong></p>
                `;

                if (currentRole === "admin") {
                    adminDiv.innerHTML +=
                        baseInfo +
                        `
                        <p>üõ† ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: <a href="${t.workLink || "#"}" target="_blank">${t.workLink || "-"}</a></p>
                        <p>üí¨ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${t.note || "-"}</p>
                        <p>üìÖ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${submitDateFormatted}</p>
                        <textarea id="adminComment-${t.id}" placeholder="‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå" rows="3">${t.comment || ''}</textarea>
                        <button onclick="updateStatus(${t.id}, 'approved', document.getElementById('adminComment-${t.id}').value)">‚úî ‡∏ú‡πà‡∏≤‡∏ô</button>
                        <button onclick="updateStatus(${t.id}, 'edit', document.getElementById('adminComment-${t.id}').value)">‚úè ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button style="background:#f44336;" onclick="deleteTask(${t.id})">üóë ‡∏•‡∏ö</button>
                    </div>
                    `;
                } else if (
                    currentRole === "user" &&
                    t.assignTo.toLowerCase() === currentUser.toLowerCase()
                ) {
                    if (t.status === "assigned" || t.status === "edit") {
                        userDiv.innerHTML +=
                            baseInfo +
                            `
                            <textarea id="userWorkLink-${t.id}" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" rows="2">${t.workLink || ''}</textarea>
                            <textarea id="userNote-${t.id}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á" rows="3">${t.note || ''}</textarea>
                            <button onclick="submitWork(${t.id}, document.getElementById('userWorkLink-${t.id}').value, document.getElementById('userNote-${t.id}').value)">üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
                        </div>
                        `;
                    } else if (t.status === "submitted" || t.status === "approved") {
                        userSub.innerHTML +=
                            baseInfo +
                            `
                            <p>üõ† ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: <a href="${t.workLink || "#"}" target="_blank">${t.workLink || "-"}</a></p>
                            <p>üí¨ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${t.note || "-"}</p>
                            <p>üóí ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${t.comment || "-"}</p>
                            <p>üìÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${submitDateFormatted}</p>
                        </div>
                        `;
                    }
                }
            });
        }

        // --- CRUD Operations (Functions calling Apps Script) ---

        // Add a new task (Admin only)
        async function addTask() {
            const title = document.getElementById("taskTitle").value;
            const orderDate = document.getElementById("taskOrderDate").value;
            const due = document.getElementById("taskDueDate").value;
            const brief = document.getElementById("taskBrief").value;
            const assignTo = document.getElementById("taskAssignTo").value;
            const adminNote = document.getElementById("taskAdminNote").value;

            if (!title || !orderDate || !due || !assignTo || assignTo === "addNewUser") {
                alert("‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô: ‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á, ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á, ‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ");
                return;
            }

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        action: "add",
                        title,
                        orderDate,
                        due,
                        brief,
                        assignTo,
                        adminNote
                    }),
                });
                const result = await response.text();
                if (result === "success") {
                    alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    // Clear form fields
                    document.getElementById("taskTitle").value = "";
                    document.getElementById("taskOrderDate").value = "";
                    document.getElementById("taskDueDate").value = "";
                    document.getElementById("taskBrief").value = "";
                    document.getElementById("taskAdminNote").value = "";
                    fetchTasks(); // Re-fetch tasks to update the UI
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô: " + result);
                }
            } catch (error) {
                console.error("Error adding task:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error.message);
            }
        }

        // Submit work (User only)
        async function submitWork(id, workLink, note) {
            const task = tasks.find(t => t.id === id);
            if (!task) {
                console.error("Task not found for ID:", id);
                return;
            }

            if (!workLink) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
                return;
            }

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        action: "submit",
                        id: id,
                        workLink: workLink,
                        note: note,
                        date: new Date().toISOString() // Send current date/time in ISO format
                    }),
                });
                const result = await response.text();
                if (result === "submitted") {
                    alert("‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    fetchTasks(); // Re-fetch tasks to update the UI
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô: " + result);
                }
            } catch (error) {
                console.error("Error submitting work:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error.message);
            }
        }

        // Update status (Admin only)
        async function updateStatus(id, newStatus, comment) {
            const task = tasks.find(t => t.id === id);
            if (!task) {
                console.error("Task not found for ID:", id);
                return;
            }

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        action: "updateStatus",
                        id: id,
                        status: newStatus,
                        comment: comment // Send admin's comment
                    }),
                });
                const result = await response.text();
                if (result === "status updated") {
                    alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    fetchTasks(); // Re-fetch tasks to update the UI
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: " + result);
                }
            } catch (error) {
                console.error("Error updating status:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error.message);
            }
        }

        // Delete task (Admin only)
        async function deleteTask(id) {
            if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ")) {
                return;
            }
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        action: "delete",
                        id: id,
                    }),
                });
                const result = await response.text();
                if (result === "deleted") {
                    alert("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    fetchTasks(); // Re-fetch tasks to update the UI
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô: " + result);
                }
            } catch (error) {
                console.error("Error deleting task:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error.message);
            }
        }

        // Initial setup when the page loads
        document.addEventListener("DOMContentLoaded", () => {
            fetchTasks(); // Fetch tasks first
            // Set initial role and user based on dropdowns after they are populated
            document.getElementById("userRole").value = currentRole;
            // The populateUserDropdown will set currentUser and the select value
            // and then call updateUIForRole()
        });

    </script>
</body>
</html>
