<!-- ========================== HTML (Frontend) ========================== -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบจัดการงาน</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #1e1e2f; color: #fff; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: auto; padding: 20px; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none;
    }
    textarea { resize: vertical; }
    button { background-color: #5865f2; color: white; cursor: pointer; }
    button:hover { background-color: #4752c4; }
    .task-card { background: #2c2f3f; padding: 15px; margin: 10px 0; border-radius: 5px; }
    .hidden { display: none; }
    .status-submitted { color: orange; }
    .status-assigned { color: lightgreen; }
    .status-edit { color: red; }
  </style>
</head>
<body>
  <div class="container" id="loginPage">
    <h2>เข้าสู่ระบบ</h2>
    <input id="loginUsername" placeholder="ชื่อผู้ใช้" />
    <input id="loginPassword" type="password" placeholder="รหัสผ่าน" />
    <button onclick="login()">เข้าสู่ระบบ</button>
  </div>

  <div class="container hidden" id="adminPage">
    <button onclick="logout()">ออกจากระบบ</button>
    <h2>เพิ่มงานใหม่</h2>
    <input id="taskCreatedDate" readonly />
    <input id="taskTitle" placeholder="ชื่องาน" />
    <select id="taskAssignTo"></select>
    <input id="taskDue" type="date" />
    <textarea id="taskBrief" placeholder="รายละเอียด/ลิงก์บรีฟ"></textarea>
    <button onclick="addTask()">บันทึกงาน</button>
    <hr>
    <div id="adminTasks"></div>
  </div>

  <div class="container hidden" id="userPage">
    <button onclick="logout()">ออกจากระบบ</button>
    <h2>งานของฉัน</h2>
    <div id="userTasks"></div>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwNYhPrxqiy3JI9Vaj2Bs7kcpvuJh7F_EOAIZtPV0BcrAj2NdrsZtq0LB9lPj5Mo5i1Ng/exec';
const dummyTasks = [];
let currentUser = "";

const userCredentials = {
  "admin": "1234",
  "luklnwza": "1234"
};

function login() {
  const u = document.getElementById('loginUsername').value.trim().toLowerCase();
  const p = document.getElementById('loginPassword').value;
  if (!u || userCredentials[u] !== p) return alert("ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง");
  currentUser = u;
  document.getElementById('loginPage').classList.add('hidden');
  u === 'admin' ? document.getElementById('adminPage').classList.remove('hidden') : document.getElementById('userPage').classList.remove('hidden');
  loadTasksFromSheet();
  document.getElementById("taskCreatedDate").value = new Date().toLocaleDateString("th-TH");
  loadUserSelect();
}

function logout() {
  currentUser = "";
  document.getElementById('adminPage').classList.add('hidden');
  document.getElementById('userPage').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
}

function addTask() {
  const t = {
    createdDate: document.getElementById('taskCreatedDate').value,
    title: document.getElementById('taskTitle').value,
    assignTo: document.getElementById('taskAssignTo').value,
    due: document.getElementById('taskDue').value,
    brief: document.getElementById('taskBrief').value,
    status: "assigned"
  };
  fetch(WEB_APP_URL, {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(t)
  });
  dummyTasks.push(t);
  renderAdminTasks();
}

function loadTasksFromSheet() {
  fetch(WEB_APP_URL)
    .then(r => r.json())
    .then(data => {
      dummyTasks.length = 0;
      data.forEach(t => dummyTasks.push(t));
      currentUser === 'admin' ? renderAdminTasks() : renderUserTasks();
    });
}

function loadUserSelect() {
  const sel = document.getElementById('taskAssignTo');
  sel.innerHTML = Object.keys(userCredentials)
    .filter(u => u !== 'admin')
    .map(u => `<option value="${u}">${u}</option>`).join('');
}

function renderAdminTasks() {
  document.getElementById('adminTasks').innerHTML = dummyTasks.map(t => `
    <div class="task-card">
      <h3>${t.title}</h3>
      <p>มอบหมายให้: ${t.assignTo} | วันที่สั่ง: ${t.createdDate} | กำหนดส่ง: ${t.due}</p>
      <p>ลิงก์: <a href="${t.brief}" target="_blank">เปิดบรีฟ</a></p>
      <p>สถานะ: <span class="status-${t.status}">${t.status}</span></p>
    </div>`).join('');
}

function renderUserTasks() {
  document.getElementById('userTasks').innerHTML = dummyTasks.filter(t => t.assignTo === currentUser).map(t => `
    <div class="task-card">
      <h3>${t.title}</h3>
      <p>วันที่สั่ง: ${t.createdDate} | กำหนดส่ง: ${t.due}</p>
      <p>ลิงก์: <a href="${t.brief}" target="_blank">เปิดบรีฟ</a></p>
      <p>สถานะ: <span class="status-${t.status}">${t.status}</span></p>
    </div>`).join('');
}
</script>
</body>
</html>
