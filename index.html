<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        background: #f0f2f5;
    }
    .container {
        max-width: 960px;
        margin: 20px auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
        text-align: center;
        color: #333;
    }
    .role-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
        justify-content: center;
    }
    .role-selector select, .add-task-form select, .add-task-form input, .add-task-form textarea {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        width: 100%;
        max-width: 300px;
        box-sizing: border-box;
    }
    .add-task-form {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .add-task-form label {
        font-weight: 600;
        display: block;
        margin: 10px 0 5px;
    }
    .add-task-form button {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
    }
    .add-task-form button:hover {
        background: #218838;
    }
    .task-section {
        margin-bottom: 30px;
    }
    .task-section h2 {
        border-bottom: 2px solid #ddd;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }
    .card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .card h4 {
        margin: 0 0 10px;
    }
    .card p {
        margin: 4px 0;
    }
    .status-green { color: green; font-weight: 600; }
    .status-orange { color: orange; font-weight: 600; }
    .status-yellow { color: #999900; font-weight: 600; }
    button.action-btn {
        margin: 5px 5px 0 0;
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.2s;
        color: white;
    }
    .btn-approve { background: #28a745; }
    .btn-edit { background: #ff9800; }
    .btn-delete { background: #f44336; }
    .btn-submit { background: #007bff; }
    button.action-btn:hover { opacity: 0.9; }
</style>
</head>
<body>
<div class="container">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h1>

    <div class="role-selector">
        <label>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:</label>
        <select id="userRole" onchange="changeRole()">
            <option value="admin">Admin</option>
            <option value="user">User</option>
        </select>

        <label>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</label>
        <select id="currentUserSelect" onchange="changeUser()"></select>
    </div>

    <div id="addTaskForm" class="add-task-form">
        <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
        <input type="text" id="taskTitle">

        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</label>
        <input type="date" id="taskOrderDate">

        <label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
        <input type="date" id="taskDueDate">

        <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ö‡∏£‡∏µ‡∏ü</label>
        <input type="text" id="taskBrief">

        <label>‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ</label>
        <select id="taskAssignTo"></select>

        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
        <textarea id="taskAdminNote" rows="3"></textarea>

        <button onclick="addTask()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
    </div>

    <div id="adminSection" class="task-section">
        <h2>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Admin View)</h2>
        <div id="adminTasks"></div>
    </div>

    <div id="userSection" class="task-section">
        <h2>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</h2>
        <div id="userTasks"></div>
    </div>

    <div id="userSubmittedSection" class="task-section">
        <h2>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</h2>
        <div id="userSubmitted"></div>
    </div>
</div>

<script>
const WEB_APP_URL = "‡πÉ‡∏™‡πà URL Google Apps Script ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
let tasks = [], currentRole = "admin", currentUser = "";
let allUsers = [];

function fetchTasks() {
    fetch(WEB_APP_URL)
        .then(r => r.json())
        .then(data => {
            tasks = data;
            extractUsers();
            renderTasks();
        })
        .catch(err => alert("‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err));
}

function extractUsers() {
    const users = new Set(tasks.map(t => t.assignTo).filter(Boolean));
    allUsers = Array.from(users).sort();
    const userSel = document.getElementById("currentUserSelect");
    const assignSel = document.getElementById("taskAssignTo");
    userSel.innerHTML = assignSel.innerHTML = "";
    allUsers.forEach(u => {
        userSel.innerHTML += `<option value="${u}">${u}</option>`;
        assignSel.innerHTML += `<option value="${u}">${u}</option>`;
    });
    assignSel.innerHTML += `<option value="addNewUser">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà...</option>`;
    if (currentUser && allUsers.includes(currentUser)) userSel.value = currentUser;
    else currentUser = userSel.value = allUsers[0] || "";
    assignSel.onchange = () => {
        if (assignSel.value === "addNewUser") {
            const newUser = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà");
            if (newUser && !allUsers.includes(newUser)) {
                allUsers.push(newUser);
                allUsers.sort();
                extractUsers();
                assignSel.value = newUser;
            }
        }
    }
    updateUIForRole();
}

function changeRole() {
    currentRole = document.getElementById("userRole").value;
    updateUIForRole();
    renderTasks();
}

function changeUser() {
    currentUser = document.getElementById("currentUserSelect").value;
    renderTasks();
}

function updateUIForRole() {
    document.getElementById("adminSection").style.display = currentRole === "admin" ? "block" : "none";
    document.getElementById("addTaskForm").style.display = currentRole === "admin" ? "block" : "none";
    document.getElementById("userSection").style.display = currentRole === "user" ? "block" : "none";
    document.getElementById("userSubmittedSection").style.display = currentRole === "user" ? "block" : "none";
    document.getElementById("currentUserSelect").disabled = currentRole === "admin";
}

function renderTasks() {
    const adminDiv = document.getElementById("adminTasks");
    const userDiv = document.getElementById("userTasks");
    const userSub = document.getElementById("userSubmitted");
    adminDiv.innerHTML = userDiv.innerHTML = userSub.innerHTML = "";
    tasks.forEach(t => {
        const card = `<div class="card">
            <h4>${t.title}</h4>
            <p>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${t.assignTo} | ‡∏™‡∏±‡πà‡∏á: ${t.orderDate} | ‡∏™‡πà‡∏á: ${t.due}</p>
            <p>‡∏ö‡∏£‡∏µ‡∏ü: <a href="${t.brief}" target="_blank">${t.brief || "-"}</a></p>
            <p class="${t.status === "approved" ? "status-green" : t.status === "edit" ? "status-orange" : "status-yellow"}">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${t.status}</p>`;

        if (currentRole === "admin") {
            adminDiv.innerHTML += `${card}
                <textarea id="adminComment-${t.id}" placeholder="‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå">${t.comment || ""}</textarea>
                <button class="action-btn btn-approve" onclick="updateStatus(${t.id},'approved')">‚úî ‡∏ú‡πà‡∏≤‡∏ô</button>
                <button class="action-btn btn-edit" onclick="updateStatus(${t.id},'edit')">‚úè ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="action-btn btn-delete" onclick="deleteTask(${t.id})">üóë ‡∏•‡∏ö</button>
            </div>`;
        } else if (currentRole === "user" && t.assignTo === currentUser) {
            if (t.status === "assigned" || t.status === "edit") {
                userDiv.innerHTML += `${card}
                    <textarea id="userWorkLink-${t.id}" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô">${t.workLink || ""}</textarea>
                    <textarea id="userNote-${t.id}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏">${t.note || ""}</textarea>
                    <button class="action-btn btn-submit" onclick="submitWork(${t.id})">üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
                </div>`;
            } else {
                userSub.innerHTML += `${card}
                    <p>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: <a href="${t.workLink}" target="_blank">${t.workLink || "-"}</a></p>
                    <p>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${t.note || "-"}</p>
                </div>`;
            }
        }
    });
}

function addTask() {
    const d = (id) => document.getElementById(id).value;
    if (!d("taskTitle") || !d("taskOrderDate") || !d("taskDueDate") || !d("taskAssignTo")) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            action: "add",
            title: d("taskTitle"),
            orderDate: d("taskOrderDate"),
            due: d("taskDueDate"),
            brief: d("taskBrief"),
            assignTo: d("taskAssignTo"),
            adminNote: d("taskAdminNote")
        })
    }).then(r => r.text()).then(res => {
        if (res === "success") {
            alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            fetchTasks();
        } else alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res);
    });
}

function submitWork(id) {
    const workLink = document.getElementById(`userWorkLink-${id}`).value;
    const note = document.getElementById(`userNote-${id}`).value;
    if (!workLink) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô");
    fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "submit", id, workLink, note, date: new Date().toISOString() })
    }).then(r => r.text()).then(res => {
        if (res === "submitted") fetchTasks();
        else alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res);
    });
}

function updateStatus(id, status) {
    const comment = document.getElementById(`adminComment-${id}`).value;
    fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "updateStatus", id, status, comment })
    }).then(r => r.text()).then(res => {
        if (res === "status updated") fetchTasks();
        else alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res);
    });
}

function deleteTask(id) {
    if (!confirm("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "delete", id })
    }).then(r => r.text()).then(res => {
        if (res === "deleted") fetchTasks();
        else alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res);
    });
}

document.addEventListener("DOMContentLoaded", fetchTasks);
</script>
</body>
</html>
