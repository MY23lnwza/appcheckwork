<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>à¸£à¸°à¸šà¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¸‡à¸²à¸™ Google Sheet</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header>ğŸ“‹ à¸£à¸°à¸šà¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¹à¸¥à¸°à¸•à¸£à¸§à¸ˆà¸‡à¸²à¸™ (Google Sheets)</header>

<div class="container">
  <!-- Login -->
  <div id="loginBox" class="card">
    <h2>à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</h2>
    <select id="loginRole">
      <option value="user">goblin Lv.1</option>
      <option value="admin">GM</option>
    </select>
    <input type="password" id="loginPass" placeholder="à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™" />
    <button onclick="login()">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button>
  </div>

  <!-- Admin Page -->
  <div id="adminBox" class="hidden">
    <div class="card">
      <h3>ğŸ—‚ à¹€à¸à¸´à¹ˆà¸¡à¸‡à¸²à¸™à¹ƒà¸«à¸¡à¹ˆ</h3>
      <input type="text" id="taskTitle" placeholder="à¸Šà¸·à¹ˆà¸­à¸‡à¸²à¸™" />
      <input type="date" id="taskDue" />
      <input type="text" id="taskBrief" placeholder="à¸¥à¸´à¸‡à¸à¹Œà¸šà¸£à¸µà¸Ÿà¸‡à¸²à¸™" />
      <select id="taskAssignTo">
        <option value="goblin">goblin</option>
      </select>
      <button onclick="addTask()">ğŸ“Œ à¸ªà¹ˆà¸‡à¸‡à¸²à¸™</button>
    </div>

    <div class="section-title">ğŸ“„ à¸‡à¸²à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
    <div id="adminTasks"></div>
    <button onclick="logout()" style="margin-top: 2rem; background:#f44336;">à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š</button>
  </div>

  <!-- User Page -->
  <div id="userBox" class="hidden">
    <div class="section-title">ğŸ“¬ à¸‡à¸²à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š</div>
    <div id="userTasks"></div>

    <div class="section-title">âœ… à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¹„à¸›à¹à¸¥à¹‰à¸§</div>
    <div id="userSubmitted"></div>
    <button onclick="logout()" style="margin-top: 2rem; background:#f44336;">à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š</button>
  </div>
</div>

<script src="script.js"></script>
</body>
</html>
const SHEET_URL = 'https://script.google.com/macros/s/URLà¸‚à¸­à¸‡à¸„à¸¸à¸“/exec';

let tasks = [];
let currentUser = '';
let currentRole = '';

document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !document.getElementById('loginBox').classList.contains('hidden')) {
    login();
  }
});

function login() {
  const role = document.getElementById('loginRole').value;
  const pass = document.getElementById('loginPass').value;
  if ((role === 'admin' && pass === '1234') || (role === 'user' && pass === 'Luk1234')) {
    currentUser = (role === 'admin') ? 'GM' : 'goblin';
    currentRole = role;
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById(role + 'Box').classList.remove('hidden');
    loadTasks();
  } else {
    alert('à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
  }
}

function logout() {
  currentUser = '';
  currentRole = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginBox').classList.remove('hidden');
  document.getElementById('adminBox').classList.add('hidden');
  document.getElementById('userBox').classList.add('hidden');
}

async function loadTasks() {
  try {
    const res = await fetch(SHEET_URL + '?action=read');
    tasks = await res.json();
    renderTasks();
  } catch (e) {
    alert('à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸´à¸”à¸à¸¥à¸²à¸”');
    console.error(e);
  }
}

async function addTask() {
  const title = document.getElementById('taskTitle').value.trim();
  const due = document.getElementById('taskDue').value;
  const brief = document.getElementById('taskBrief').value.trim();
  const assignTo = document.getElementById('taskAssignTo').value;
  const now = new Date().toLocaleString('th-TH');

  if (!title || !due || !assignTo) {
    alert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ à¸Šà¸·à¹ˆà¸­à¸‡à¸²à¸™, à¸à¸³à¸«à¸™à¸”à¸ªà¹ˆà¸‡ à¹à¸¥à¸° à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢à¹ƒà¸«à¹‰');
    return;
  }

  try {
    await fetch(SHEET_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'add',
        title,
        due,
        brief,
        assignTo,
        orderDate: now
      })
    });
    clearAdminForm();
    await loadTasks();
  } catch (e) {
    alert('à¸ªà¹ˆà¸‡à¸‡à¸²à¸™à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§');
    console.error(e);
  }
}

async function submitWork(id, workLink, note) {
  if (!workLink.trim()) {
    alert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ à¸¥à¸´à¸‡à¸à¹Œà¸‡à¸²à¸™');
    return;
  }
  const now = new Date().toLocaleString('th-TH');
  try {
    await fetch(SHEET_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'submit',
        id,
        workLink,
        note,
        sender: currentUser,
        date: now
      })
    });
    await loadTasks();
  } catch (e) {
    alert('à¸ªà¹ˆà¸‡à¸‡à¸²à¸™à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§');
    console.error(e);
  }
}

async function updateStatus(id, status, comment = '') {
  try {
    await fetch(SHEET_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'review', id, status, comment })
    });
    await loadTasks();
  } catch (e) {
    alert('à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§');
    console.error(e);
  }
}

async function deleteTask(id) {
  if (!confirm('à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸‡à¸²à¸™à¸™à¸µà¹‰?')) return;
  try {
    await fetch(SHEET_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'delete', id })
    });
    await loadTasks();
  } catch (e) {
    alert('à¸¥à¸šà¸‡à¸²à¸™à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§');
    console.error(e);
  }
}

function clearAdminForm() {
  document.getElementById('taskTitle').value = '';
  document.getElementById('taskDue').value = '';
  document.getElementById('taskBrief').value = '';
  document.getElementById('taskAssignTo').value = 'goblin';
}

function renderTasks() {
  const adminDiv = document.getElementById('adminTasks');
  const userDiv = document.getElementById('userTasks');
  const userSub = document.getElementById('userSubmitted');
  adminDiv.innerHTML = '';
  userDiv.innerHTML = '';
  userSub.innerHTML = '';

  tasks.forEach(t => {
    const statusClass = t.status === 'approved' ? 'status-green' :
                        t.status === 'edit' ? 'status-orange' : 'status-yellow';

    const baseInfo = `
      <div class="card" style="margin-bottom: 0.7rem;">
        <h4>${t.title}</h4>
        <p>ğŸ‘¤ à¸œà¸¹à¹‰à¸£à¸±à¸š: ${t.assignTo} | ğŸ“… à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢: ${t.orderDate}</p>
        <p>ğŸ“† à¸à¸³à¸«à¸™à¸”à¸ªà¹ˆà¸‡: ${t.due}</p>
        <p>ğŸ”— <a href="${t.brief || '#'}" target="_blank">à¸šà¸£à¸µà¸Ÿ</a></p>
        <p class="${statusClass}">à¸ªà¸–à¸²à¸™à¸°: ${t.status}</p>
    `;

    if (currentRole === 'admin') {
      adminDiv.innerHTML += baseInfo + `
        <p>ğŸ›  à¸¥à¸´à¸‡à¸à¹Œà¸‡à¸²à¸™: <a href="${t.workLink || '#'}" target="_blank">${t.workLink || '-'}</a></p>
        <textarea placeholder="à¸„à¸­à¸¡à¹€à¸¡à¸™à¸•à¹Œ" oninput="this.dataset.val = this.value"></textarea>
        <button onclick="updateStatus(${t.id}, 'approved', this.previousElementSibling.dataset.val)">âœ” à¸œà¹ˆà¸²à¸™</button>
        <button onclick="updateStatus(${t.id}, 'edit', this.previousElementSibling.dataset.val)">âœ à¹à¸à¹‰à¹„à¸‚</button>
        <button style="background:#f44336;" onclick="deleteTask(${t.id})">ğŸ—‘ à¸¥à¸š</button>
        </div>
      `;
    } else if (currentRole === 'user' && t.assignTo.toLowerCase() === 'goblin') {
      if (t.status === 'assigned' || t.status === 'edit') {
        userDiv.innerHTML += baseInfo + `
          <textarea placeholder="à¸¥à¸´à¸‡à¸à¹Œà¸‡à¸²à¸™" oninput="this.dataset.link=this.value"></textarea>
          <textarea placeholder="à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸" oninput="this.dataset.note=this.value"></textarea>
          <button onclick="submitWork(${t.id}, this.previousElementSibling.previousElementSibling.dataset.link, this.previousElementSibling.dataset.note)">ğŸ“¤ à¸ªà¹ˆà¸‡à¸‡à¸²à¸™</button>
          </div>
        `;
      } else {
        userSub.innerHTML += baseInfo + `
          <p>ğŸ’¬ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸: ${t.note || '-'}</p>
          <p>ğŸ—’ à¸„à¸­à¸¡à¹€à¸¡à¸™à¸•à¹Œ: ${t.comment || '-'}</p>
          <p>ğŸ“… à¸ªà¹ˆà¸‡à¸„à¸·à¸™à¹€à¸¡à¸·à¹ˆà¸­: ${t.date || '-'}</p>
          </div>
        `;
      }
    }
  });
}
